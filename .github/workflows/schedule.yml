name: Daily Grocery Pipeline

on:
  schedule:
    # Runs every day at 7 AM Pacific (15:00 UTC)
    - cron: "0 15 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout your repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0       # IMPORTANT: ensures latest commit
      - name: Print current commit
        run: |
          echo "Current commit:"
          git rev-parse HEAD
          echo "Latest commit on main:"
          git rev-parse origin/main
      - name: Print load.py contents
        run: |
          echo "==== LOAD FILE CONTENTS ===="
          sed -n '1,200p' pipeline/load/load.py

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Step 3: Install dependencies
      - name: Install dependencies
        run: pip install -r requirements.txt

      # Step 4: Decode Google Cloud credentials from base64
      - name: Decode Google Cloud credentials
        env:
          GOOGLE_SERVICE_ACCOUNT_B64: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_B64 }}
        run: |
          echo "$GOOGLE_SERVICE_ACCOUNT_B64" | base64 --decode > /tmp/gcp-key.json
          chmod 600 /tmp/gcp-key.json
          echo "GOOGLE_JSON_KEY_FILE_PATH=/tmp/gcp-key.json" >> $GITHUB_ENV
          echo "Decoded service account JSON written to /tmp/gcp-key.json"

      # Step 5: Run ingestion + load scripts (WITHOUT overriding env)
      - name: Run ingestion and load scripts
        run: |
          export KROGER_CLIENT_ID="${{ secrets.KROGER_CLIENT_ID }}"
          export KROGER_CLIENT_SECRET="${{ secrets.KROGER_CLIENT_SECRET }}"
          export BQ_PROJECT="daniel-grocery-project"

          echo "ðŸš€ Running ingestion script for milk, eggs, and oranges..."
          python pipeline/ingestion/latest_file.py milk eggs oranges

          echo "ðŸ“¦ Running load script to upload data to BigQuery..."
          python pipeline/load/load.py
