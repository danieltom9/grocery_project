name: Daily Grocery Pipeline

on:
  schedule:
    # Runs every day at 7 AM Pacific (15:00 UTC)
    - cron: "0 15 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      # ðŸ§¾ Step 1: Checkout your repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ðŸ“¦ Step 3: Install dependencies
      - name: Install dependencies
        run: pip install -r requirements.txt

      # ðŸ” Step 4: Create Google Cloud credentials file from secret
      - name: Set up Google Cloud credentials
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "$GOOGLE_SERVICE_ACCOUNT_JSON" > /tmp/gcp-key.json
          echo "GOOGLE_JSON_KEY_FILE_PATH=/tmp/gcp-key.json" >> $GITHUB_ENV
          echo "âœ… Service account file created at /tmp/gcp-key.json"

      # ðŸš€ Step 5: Run ingestion + load scripts
      - name: Run ingestion and load scripts
        env:
          KROGER_CLIENT_ID: ${{ secrets.KROGER_CLIENT_ID }}
          KROGER_CLIENT_SECRET: ${{ secrets.KROGER_CLIENT_SECRET }}
          BQ_PROJECT: "daniel-grocery-project"
        run: |
          echo "ðŸš€ Running ingestion script for milk, eggs, and oranges..."
          python pipeline/ingestion/latest_file.py milk eggs oranges
          echo "ðŸ“¦ Running load script to upload data to BigQuery..."
          python pipeline/load/load.py
      

      - name: Debug credential environment
        run: |
          echo "DEBUG: GOOGLE_JSON_KEY_FILE_PATH=$GOOGLE_JSON_KEY_FILE_PATH"
          echo "DEBUG: File exists? $(test -f $GOOGLE_JSON_KEY_FILE_PATH && echo yes || echo no)"
          echo "DEBUG: JSON preview:"
          head -n 20 $GOOGLE_JSON_KEY_FILE_PATH
